<!DOCTYPE html>
<!--suppress HtmlUnknownTarget -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Gamer Network</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-auth.js"></script>

    <!-- Replace YOUR_FIREBASE_VERSION with the version you're using -->
</head>
<body>

<!-- Navbar Section -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
<a class="navbar-brand" href="#">Gamer Network</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
            <a class="nav-link" href="About us.html">Home</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="UserProfile.html">Profile</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Pairing Form.html" onclick="changeNavbarColor(event)">Pairing</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Search Bar.html" onclick="changeNavbarColor(event)">Search</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="UserPost.html" onclick="changeNavbarColor(event)">Posts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Message.html" onclick="changeNavbarColor(event)">Messages</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Contact Us.html" onclick="changeNavbarColor(event)">Request</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Chat.html" onclick="changeNavbarColor(event)">Chat</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Friendship.html" onclick="changeNavbarColor(event)">Friendship</a>
        </li>
        <li class="nav-item ml-2">
            <a class="nav-link" href="Login In.html">Logout</a>
        </li>
    </ul>
</div>
</nav>


<!-- Chat Application Content -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <!-- Sending messages -->
            <form id="message-form">
                <div class="form-group">
                    <label for="message-content">Message:</label>
                    <textarea class="form-control" id="message-content" rows="3" placeholder="Type your message here..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Send</button>
                <button type="button" id="show-messages" class="btn btn-info">Show My Messages</button> <!-- Show Messages Button -->
            </form>
        </div>
        <div class="col-md-6">
            <!-- Receiving messages -->
            <div id="messages" class="message-container"></div>
        </div>
    </div>
</div>

<script>
    // Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyD18a6bP6Ec0QCsLm5bl04prN_WAchA4Is",
        authDomain: "gamtrack-3a2f2.firebaseapp.com",
        projectId: "gamtrack-3a2f2",
        storageBucket: "gamtrack-3a2f2.appspot.com",
        messagingSenderId: "492662811532",
        appId: "1:492662811532:web:4e59f354ffbc43eee384a9",
        measurementId: "G-5VTT1HQLJ1"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    let currentUsername = null;

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            db.collection('User').doc(user.uid).get().then(function(doc) {
                if (doc.exists) {
                    currentUsername = doc.data().username;
                    listenForIncomingMessages(currentUsername);
                } else {
                    console.log("No user data found!");
                }
            }).catch(function(error) {
                console.log("Error fetching user:", error);
            });

            document.getElementById('message-form').addEventListener('submit', function(e) {
                e.preventDefault();
                var messageContent = document.getElementById('message-content').value;
                if (messageContent.trim() === "") return; // Prevent empty messages

                db.collection('DirectMessage').add({
                    content: messageContent,
                    sender: currentUsername,
                    receiver: 'receiverUsername', // Placeholder: Adapt based on your app's logic
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(function() {
                    document.getElementById('message-content').value = ''; // Clear the textarea
                }).catch(function(error) {
                    console.error("Error sending message: ", error);
                });
            });

            document.getElementById('show-messages').addEventListener('click', function() {
                showSentMessages(currentUsername);
            });
        } else {
            console.log("User is not signed in.");
        }
    });

    function listenForIncomingMessages(username) {
        db.collection('DirectMessage')
            .where('receiver', '==', username)
            .orderBy('createdAt')
            .onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = ''; // Clear existing messages
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.textContent = `${messageData.sender}: ${messageData.content}`;
                    messagesContainer.appendChild(messageElement);
                });
            });
    }

    function showSentMessages(username) {
        db.collection('DirectMessage')
            .where('sender', '==', username)
            .orderBy('createdAt')
            .onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '<h5>My Sent Messages</h5>'; // Add a header and clear previous messages
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.textContent = `To ${messageData.receiver}: ${messageData.content}`;
                    messagesContainer.appendChild(messageElement);
                });
            });
    }
</script>
</body>
</html>
